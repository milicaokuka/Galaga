
#include "battle_city.h"
#include "map.h"
#include "xparameters.h"
#include "xil_io.h"
#include "xio.h"
#include "stdlib.h"
#include <stdio.h>

/*
* GENERATED BY BC_MEM_PACKER
* DATE: Wed Jul 08 21:00:48 2015
*/

// ***** 16x16 IMAGES *****

#define IMG_16x16_cigle			0x063F
#define IMG_16x16_coin			0x063F
#define IMG_16x16_crno			0x063F
#define IMG_16x16_enemi1		0x0F3F
#define IMG_16x16_mario			0x04FF
#define IMG_16x16_plavacigla	0x063F

#define IMG_16x16_muva_skupljena	0x0F7F
#define IMG_16x16_muva_rasirena		0x0F3F //glavna muva sto ce biti skroz gore, i koju moras 2 puta pogoditi da bi je ubio

#define IMG_16x16_muva_skupljena_plava	    0x07BF
#define IMG_16x16_muva_rasirena_plava		0x077F

#define IMG_16x16_metak				0x067F
#define IMG_16x16_metak_muva		0x06BF

#define IMG_16x16_muva2_skupljena   0x09BF //drugi red, crvene muve
#define IMG_16x16_muva2_rasirena    0x097F

#define IMG_16x16_muva3_skupljena   0x0BBF //treci red, zunzare
#define IMG_16x16_muva3_rasirena    0x0B7F

// ***** MAP *****

#define MAP_BASE_ADDRESS			0x10BF


#define MAP_X							0
#define MAP_X2							640
#define MAP_Y							4
#define MAP_W							64
#define MAP_H							56

#define REGS_BASE_ADDRESS               ( MAP_BASE_ADDRESS + MAP_WIDTH * MAP_HEIGHT )



#define BTN_DOWN( b )                   ( !( b & 0x01 ) )
#define BTN_UP( b )                     ( !( b & 0x10 ) )
#define BTN_LEFT( b )                   ( !( b & 0x02 ) )
#define BTN_RIGHT( b )                  ( !( b & 0x08 ) )
#define BTN_SHOOT( b )                  ( !( b & 0x04 ) )


#define BASE_REG_L					   0
#define BASE_REG_H	                   1

//za brod reg
#define BROD_REG_L                     2
#define BROD_REG_H                     3

//prvi red muva reg
#define MUVA_1_REG_L                   4
#define MUVA_1_REG_H                   5
#define MUVA_1_REG_L2                  6
#define MUVA_1_REG_H2                  7
#define MUVA_1_REG_L3                  8
#define MUVA_1_REG_H3                  9
#define MUVA_1_REG_L4                  10
#define MUVA_1_REG_H4                  11
#define MUVA_1_REG_L5                  12
#define MUVA_1_REG_H5                  13

//muvin metak reg
#define MUVA_1_METAK_REG_L			   14
#define MUVA_1_METAK_REG_H			   15
#define MUVA_2_METAK_REG_L			   42
#define MUVA_2_METAK_REG_H			   43
#define MUVA_3_METAK_REG_L			   44
#define MUVA_3_METAK_REG_H			   45
#define MUVA_4_METAK_REG_L			   60
#define MUVA_4_METAK_REG_H 			   61
#define MUVA_5_METAK_REG_L			   62
#define MUVA_5_METAK_REG_H			   63


//od broda metak reg
#define BROD_METAK_REG_L			   16
#define BROD_METAK_REG_H			   17

//drugi red muva reg
#define MUVA_2_REG_L				   18
#define MUVA_2_REG_H				   19
#define MUVA_2_REG_L2				   20
#define MUVA_2_REG_H2				   21
#define MUVA_2_REG_L3				   22
#define MUVA_2_REG_H3				   23
#define MUVA_2_REG_L4				   24
#define MUVA_2_REG_H4				   25
#define MUVA_2_REG_L5				   26
#define MUVA_2_REG_H5				   27


#define MUVA_2_REG_L6				   52
#define MUVA_2_REG_H6				   53
#define MUVA_2_REG_L7				   54
#define MUVA_2_REG_H7				   55

//treci red muva reg
#define MUVA_3_REG_L				   28
#define MUVA_3_REG_H				   29
#define MUVA_3_REG_L2				   30
#define MUVA_3_REG_H2				   31
#define MUVA_3_REG_L3				   32
#define MUVA_3_REG_H3				   33
#define MUVA_3_REG_L4				   34
#define MUVA_3_REG_H4				   35
#define MUVA_3_REG_L5				   36
#define MUVA_3_REG_H5				   37
#define MUVA_3_REG_L6				   38
#define MUVA_3_REG_H6				   39
#define MUVA_3_REG_L7				   40
#define MUVA_3_REG_H7				   41


#define MUVA_3_REG_L8				   56
#define MUVA_3_REG_H8				   57
#define MUVA_3_REG_L9				   58
#define MUVA_3_REG_H9				   59

#define ZIVOT_1_REG_L1				   46
#define ZIVOT_1_REG_H1				   47
#define ZIVOT_2_REG_L2				   48
#define ZIVOT_2_REG_H2				   49
#define ZIVOT_3_REG_L3				   50
#define ZIVOT_3_REG_H3				   51





#define BROJ_MUVA  					   3
#define BROJ_MUVA2					   5
#define BROJ_MUVA3					   7

#define BROJ_ZIVOTA 				   3



//Xuint32 cursor_position;
/*#define GRAPHICS_MEM_OFF 0x2000000
#define TEXT_MEM_OFF 0x1000000

#define VGA_PERIPH_MEM_mWriteMemory(Address, Data) \
 	Xil_Out32(Address, (Xuint32)(Data))
#define VGA_PERIPH_MEM_mReadMemory(Address) \
 	Xil_In32(Address)*/



int broj_zivota = BROJ_ZIVOTA;
int  prvi1 = 1;
int	 prvi2 = 1;
int  prvi3 = 1;
int brojac_polozaja = 0;
int brojac_polozaja_y = 0;


int broj_muva = BROJ_MUVA;
int broj_muva_2 = BROJ_MUVA2;
int broj_muva_3 = BROJ_MUVA3;

int brojac1 = 0;
int i,j ;

int y = 450;
int y_muva_1 = 449;
int y_muva_2 = 449;
int y_muva_3 = 449;
int y_muva_4 = 449;
int y_muva_5 = 449;

int muva_puca = 0;
int puca_brojac = 0;

int polozaj = 1;




typedef enum {
    b_false,
    b_true
} bool_t;

typedef enum {
    DIR_LEFT,
    DIR_RIGHT,


} direction_t;

typedef struct {
    unsigned int    x;
    unsigned int    y;
    direction_t dir;
    unsigned int    type;

    bool_t          destroyed;
    bool_t			first_shoot;


    unsigned int	reg_l;
    unsigned int	reg_h;
} characters;

characters mario = {
    320,	                        // x
    450, 		                     // y
    DIR_RIGHT,              		// dir
    IMG_16x16_mario,  			// type

    b_false,                		// destroyed
    b_false,

    BROD_REG_L ,            		// reg_l
    BROD_REG_H              		// reg_h
};




characters muve1_1 = {
	270,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_enemi1,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_1_REG_L,             		// reg_l
    MUVA_1_REG_H            		// reg_h
};

characters muve1_2 = {
	290,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_enemi1,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_1_REG_L2,            		// reg_l
    MUVA_1_REG_H2             		// reg_h
};

characters muve1_3  = {
	310,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_enemi1,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_1_REG_L3,            		// reg_l
    MUVA_1_REG_H3             		// reg_h
};

// u kolonu lijevo.

characters muve1_4  = {
	23,						// x
    150,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_enemi1,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_1_REG_L4,            		// reg_l
    MUVA_1_REG_H4             		// reg_h
};

// u kolonu desno

characters muve1_5  = {
	620,						// x
    150,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_enemi1,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_1_REG_L5,            		// reg_l
    MUVA_1_REG_H5             		// reg_h
};


//drugi red za crvene muve

characters muve2_1 = {
	250,						// x
    75,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L,            		// reg_l
    MUVA_2_REG_H             		// reg_h
};

characters muve2_2 = {
	270,						// x
	75,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L2,            		// reg_l
    MUVA_2_REG_H2             		// reg_h
};

characters muve2_3 = {
	290,						// x
	75,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L3,            		// reg_l
    MUVA_2_REG_H3           		// reg_h
};
characters muve2_4 = {
	310,						// x
	75,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L4,            		// reg_l
    MUVA_2_REG_H4           		// reg_h
};
characters muve2_5 = {
	330,						// x
	75,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L5,            		// reg_l
    MUVA_2_REG_H5           		// reg_h
};


characters muve2_6 = {
	23,						// x
	175,						// y
	DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L6,            		// reg_l
    MUVA_2_REG_H6           		// reg_h
};

characters muve2_7 = {
	620,						// x
	175,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva2_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_2_REG_L7,            		// reg_l
    MUVA_2_REG_H7           		// reg_h
};


//treci red za zunzare


characters muve3_1 = {
	230,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L,            		// reg_l
    MUVA_3_REG_H           		// reg_h
};
characters muve3_2 = {
	250,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L2,            		// reg_l
    MUVA_3_REG_H2           		// reg_h
};
characters muve3_3 = {
	270,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L3,            		// reg_l
    MUVA_3_REG_H3           		// reg_h
};
characters muve3_4 = {
	290,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L4,            		// reg_l
    MUVA_3_REG_H4           		// reg_h
};
characters muve3_5 = {
	310,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L5,            		// reg_l
    MUVA_3_REG_H5           		// reg_h
};

characters muve3_6 = {
	330,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L6,            		// reg_l
    MUVA_3_REG_H6           		// reg_h
};

characters muve3_7 = {
	350,						// x
	100,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L7,            		// reg_l
    MUVA_3_REG_H7           		// reg_h
};

characters muve3_8 = {
	23,						// x
	200,						// y
	DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L8,            		// reg_l
    MUVA_3_REG_H8           		// reg_h
};

characters muve3_9 = {
	620,						// x
	200,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_muva3_rasirena,   // type

    b_false,                		// destroyed
    b_false,

    MUVA_3_REG_L9,            		// reg_l
    MUVA_3_REG_H9           		// reg_h
};



characters metak = {
	330,						// x
	50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_metak,  		// type

    b_false,                		// destroyed
    b_false,

    BROD_METAK_REG_L,            		// reg_l
    BROD_METAK_REG_H// reg_h
};

characters metak_muva_1 = {
	200,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_metak_muva,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_1_METAK_REG_L,            		// reg_l
    MUVA_1_METAK_REG_H 		// reg_l
              		// reg_h
};

characters metak_muva_2 = {
	200,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_metak_muva,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_2_METAK_REG_L,            		// reg_l
    MUVA_2_METAK_REG_H 		// reg_l
              		// reg_h
};

characters metak_muva_3 = {
	200,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_metak_muva,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_3_METAK_REG_L,            		// reg_l
    MUVA_3_METAK_REG_H 		// reg_l
              		// reg_h
};
characters metak_muva_4 = {
	200,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_metak_muva,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_4_METAK_REG_L,            		// reg_l
    MUVA_4_METAK_REG_H 		// reg_l
              		// reg_h
};
characters metak_muva_5 = {
	200,						// x
    50,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_metak_muva,  		// type

    b_false,                		// destroyed
    b_false,

    MUVA_5_METAK_REG_L,            		// reg_l
    MUVA_5_METAK_REG_H 		// reg_l
              		// reg_h
};
characters zivot_1 = {
	30,						// x
    20,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_mario,  		// type

    b_false,                		// destroyed
    b_false,

    ZIVOT_1_REG_L1,            		// reg_l
    ZIVOT_1_REG_H1 		// reg_l
              		// reg_h
};

characters zivot_2 = {
	50,						// x
    20,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_mario,  		// type

    b_false,                		// destroyed
    b_false,

    ZIVOT_2_REG_L2,            		// reg_l
    ZIVOT_2_REG_H2 		// reg_l
              		// reg_h
};

characters zivot_3 = {
	70,						// x
    20,						// y
    DIR_LEFT,              		// dir
    IMG_16x16_mario,  		// type

    b_false,                		// destroyed
    b_false,

    ZIVOT_3_REG_L3,            		// reg_l
    ZIVOT_3_REG_H3 		// reg_l
              		// reg_h
};



bool_t puca = b_false;
bool_t puca_muva = b_true;
characters muve[BROJ_MUVA];
characters muve_2[BROJ_MUVA2];
characters muve_3[BROJ_MUVA3];
characters muve_4[3];
characters muve_5[3];


unsigned int rand_lfsr113( void )
{
	static unsigned int z1 = 12345, z2 = 12345 ;
	unsigned int b;

	b  = ( ( z1 << 6 ) ^ z1 ) >> 13;
	z1 = ( ( z1 & 4294967294U ) << 18 ) ^ b;
	b  = ( ( z2 << 2 ) ^ z2 ) >> 27;
	z2 = ( ( z2 & 4294967288U ) << 2) ^ b;


	return ( z1 ^ z2 );
}

static void chhar_spawn( characters * chhar )
{
	Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + chhar->reg_l ),  (unsigned int)0x8F000000  | (unsigned int)chhar->type );
	Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + chhar->reg_h ),  (chhar->y << 16) | chhar->x );
}

static void map_update( map_entry_t * map )
{
    unsigned int i;

    for( i = 0; i < MAP_WIDTH * MAP_HEIGHT; i++ ) {
        if( map[ i ].update ) {
            map[ i ].update = 0;

            Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( MAP_BASE_ADDRESS + i ), ( (unsigned int)map[ i ].z << 24 ) | ( (unsigned int)map[ i ].rot << 16 ) | (unsigned int)map[ i ].ptr );
        }
    }
}

static void map_reset( map_entry_t * map )
{
    unsigned int i;

    for( i = 0; i < MAP_WIDTH * MAP_HEIGHT; i++ ) {
        Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( MAP_BASE_ADDRESS + i ), ( (unsigned int)map[ i ].z << 24 ) | ( (unsigned int)map[ i ].rot << 16 ) | (unsigned int)map[ i ].ptr );
    }

    for( i = 0; i <= 20; i += 2 ) {
    	Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + i ), (unsigned int)0x0F000000 );
    }
}


static void destroy( characters * coin,unsigned int x, unsigned int ya){
	if (coin->type == IMG_16x16_muva_skupljena || coin->type == IMG_16x16_muva_rasirena ){
		coin->first_shoot = b_true;
	}

	else
	{
		if (coin->type == IMG_16x16_mario){
			broj_zivota = broj_zivota - 1;
		}

		coin->destroyed = b_true;
		if(coin->type == IMG_16x16_metak){
			puca = b_false;
			y = 450;
		}

		Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + coin->reg_l ), (unsigned int)0x8F000000  | IMG_16x16_crno );
		Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + coin->reg_h ), ( coin>ya << 16 ) | coin->x );

	}

}

static bool_t mario_move( map_entry_t * map, characters * tank, direction_t dir)
{
	unsigned int    x;
    unsigned int    y;


    map_entry_t *   tl;
    map_entry_t *   tc;
    map_entry_t *   tr;
    map_entry_t *   cl;
	map_entry_t *   cc;
	map_entry_t *   cr;
	map_entry_t *   bl;
	map_entry_t *   bc;
	map_entry_t *   br;



    if( tank->x > (( MAP_X + MAP_W ) * 16 - 16 ) ||
        tank->y > ( MAP_Y + MAP_H ) * 16 - 16 ) {
        return b_false;
    }

    x = tank->x;
    y = tank->y;

    // Make sure that coordinates will stay within map boundaries after moving.
    if( dir == DIR_LEFT ) {
        if( x >  24  )
        	x--;
    } else if( dir == DIR_RIGHT ) {
        if( x <   600 )
        	x++;
    }


    tl = &map[ ( y / 16 ) * MAP_WIDTH + ( x / 16 ) ];
	tc = &map[ ( y / 16 ) * MAP_WIDTH + ( ( x + 7 ) / 16 ) ];
	tr = &map[ ( y / 16 ) * MAP_WIDTH + ( ( x + 15 ) / 16 ) ];
	cl = &map[ ( ( y + 7 ) / 16 ) * MAP_WIDTH + ( x / 16 ) ];
	cc = &map[ ( ( y + 7 ) / 16 ) * MAP_WIDTH + ( ( x + 7 ) / 16 ) ];
	cr = &map[ ( ( y + 7 ) / 16 ) * MAP_WIDTH + ( ( x + 15 ) / 16 ) ];
	bl = &map[ ( ( y + 15 ) / 16 ) * MAP_WIDTH + ( x / 16 ) ];
	bc = &map[ ( ( y + 15 ) / 16 ) * MAP_WIDTH + ( ( x + 7 ) / 16 ) ];
	br = &map[ ( ( y + 15 ) / 16 ) * MAP_WIDTH + ( ( x + 15 ) / 16 ) ];

    if( tank->x != x || tank->y != y ) {
        // Tank can move if water, iron or brick wall isn't ahead.
        if( tl->ptr != IMG_16x16_plavacigla && tl->ptr != IMG_16x16_cigle && tl->ptr != IMG_16x16_enemi1 &&
			tc->ptr != IMG_16x16_plavacigla && tc->ptr != IMG_16x16_cigle && tc->ptr != IMG_16x16_enemi1 &&
			tr->ptr != IMG_16x16_plavacigla && tr->ptr != IMG_16x16_cigle && tr->ptr != IMG_16x16_enemi1 &&
			cl->ptr != IMG_16x16_plavacigla && cl->ptr != IMG_16x16_cigle && cl->ptr != IMG_16x16_enemi1 &&
			cc->ptr != IMG_16x16_plavacigla && cc->ptr != IMG_16x16_cigle && cc->ptr != IMG_16x16_enemi1 &&
			cr->ptr != IMG_16x16_plavacigla && cr->ptr != IMG_16x16_cigle && cr->ptr != IMG_16x16_enemi1 &&
        	bl->ptr != IMG_16x16_plavacigla && bl->ptr != IMG_16x16_cigle && bl->ptr != IMG_16x16_enemi1 &&
        	bc->ptr != IMG_16x16_plavacigla && bc->ptr != IMG_16x16_cigle && bc->ptr != IMG_16x16_enemi1 &&
        	br->ptr != IMG_16x16_plavacigla && br->ptr != IMG_16x16_cigle && br->ptr != IMG_16x16_enemi1 ) {

            tank->x = x;
            tank->y = y;

            if( tank->dir != dir ) {
                tank->dir = dir;

                Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + tank->reg_l ), (unsigned int)0x8F000000  | tank->type );
            }

            Xil_Out32( XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 4 * ( REGS_BASE_ADDRESS + tank->reg_h ), ( tank->y << 16 ) | tank->x );

            return b_true;

        }


    }

return b_false;
}



void promeni_polozaj(characters muva[], int broj){

	if(brojac_polozaja > 100){
	for (i=0;i<broj;i++){
		muva[i].x = muva[i].x + polozaj;
	}
	}
	brojac_polozaja++;
}

void promeni_polozaj_y(characters muva[], int broj){

	if(brojac_polozaja > 100){
	for (i=0;i<broj;i++){
		muva[i].x = muva[i].x - polozaj;
		//muva[i].y = muva[i].y + polozaj;
	}
	}
	brojac_polozaja++;
}

void muva_leti(characters  muva[], int broj, int vrsta){



	for(i = 0 ; i < broj ; i++){
		if (muva[i].destroyed == b_false){


			if(brojac_polozaja > 100){
				if(muva[i].x < 24){
					polozaj = 1;

				}
				else if(muva[i].x >  600){
					polozaj = -1;

				}
			}





		if(brojac1  ==  i && vrsta==1){
			if(muva[i].first_shoot == b_false){
				muva[i].type = IMG_16x16_muva_rasirena;
			}else{
				muva[i].type = IMG_16x16_muva_rasirena_plava;
			}
		}
		if(brojac1 == i && vrsta==2){
			muva[i].type = IMG_16x16_muva2_rasirena;
		}
		if(brojac1 == i && vrsta==3){
			muva[i].type = IMG_16x16_muva3_rasirena;
		}



		if(brojac1 == 150 + i && vrsta==1){
			if(muva[i].first_shoot == b_false){
				muva[i].type = IMG_16x16_muva_skupljena;
			}else{
				muva[i].type = IMG_16x16_muva_skupljena_plava;
			}
		}
		if(brojac1 == 150 + i && vrsta==2){
			muva[i].type = IMG_16x16_muva2_skupljena;

		}
		if(brojac1 == 150 + i && vrsta==3){
			muva[i].type = IMG_16x16_muva3_skupljena;

		}

	 if(brojac1 == 250){


		brojac1 = -1;
	 }
	 brojac1++;






	 chhar_spawn(&muva[i]);
	}
	}


}

void muva_letiDESNO(characters  muva[], int broj, int vrsta){



	for(i = 0 ; i < broj ; i++){
		if (muva[i].destroyed == b_false){


			if(brojac_polozaja > 100){
				if(muva[i].x < 35){
					polozaj = 1;

				}
				else if(muva[i].x >  600){
					polozaj = 1;

				}
			}





		if(brojac1  ==  i && vrsta==1){
			if(muva[i].first_shoot == b_false){
				muva[i].type = IMG_16x16_muva_rasirena;
			}else{
				muva[i].type = IMG_16x16_muva_rasirena_plava;
			}
		}
		if(brojac1 == i && vrsta==2){
			muva[i].type = IMG_16x16_muva2_rasirena;
		}
		if(brojac1 == i && vrsta==3){
			muva[i].type = IMG_16x16_muva3_rasirena;
		}



		if(brojac1 == 150 + i && vrsta==1){
			if(muva[i].first_shoot == b_false){
				muva[i].type = IMG_16x16_muva_skupljena;
			}else{
				muva[i].type = IMG_16x16_muva_skupljena_plava;
			}
		}
		if(brojac1 == 150 + i && vrsta==2){
			muva[i].type = IMG_16x16_muva2_skupljena;

		}
		if(brojac1 == 150 + i && vrsta==3){
			muva[i].type = IMG_16x16_muva3_skupljena;

		}

	 if(brojac1 == 250){


		brojac1 = -1;
	 }
	 brojac1++;






	 chhar_spawn(&muva[i]);
	}
	}


}


void muva_leti2R(characters  muva[],characters muvaBIG[] ,int broj, int vrsta){

int polozajR = 0;

	for(i = 0 ; i < broj ; i++){
		if (muva[i].destroyed == b_false){

			muva[i].x+=1;
			muva[i].y-=2;
			if(muva[i].x == muvaBIG[1].x-20){

				muvaBIG[0]=muva[i];
			}





		if(brojac1  ==  i && vrsta==1){
			if(muva[i].first_shoot == b_false){
				muva[i].type = IMG_16x16_muva_rasirena;
			}else{
				muva[i].type = IMG_16x16_muva_rasirena_plava;
			}
		}
		if(brojac1 == i && vrsta==2){
			muva[i].type = IMG_16x16_muva2_rasirena;
		}
		if(brojac1 == i && vrsta==3){
			muva[i].type = IMG_16x16_muva3_rasirena;
		}



		if(brojac1 == 150 + i && vrsta==1){
			if(muva[i].first_shoot == b_false){
				muva[i].type = IMG_16x16_muva_skupljena;
			}else{
				muva[i].type = IMG_16x16_muva_skupljena_plava;
			}
		}
		if(brojac1 == 150 + i && vrsta==2){
			muva[i].type = IMG_16x16_muva2_skupljena;

		}
		if(brojac1 == 150 + i && vrsta==3){
			muva[i].type = IMG_16x16_muva3_skupljena;

		}

	 if(brojac1 == 250){


		brojac1 = -1;
	 }
	 brojac1++;






	 chhar_spawn(&muva[i]);
	 chhar_spawn(&muvaBIG[i]);
	}
	}


}


void muva_shoot(characters  *muva, characters * metak_muva, characters * brod, int *y){


	if(*y > 450)	{		// ako je dosao do dole, krece iz pocetka

		*y =muva->y;

	}



	int  x = muva->x;

	if(*y == muva->y){	// proverava da li je metak upravo ispaljen
		metak_muva->x = x;

	}

	metak_muva->y = *y;	 // metak uzima kordinate od globalne promenjive

		*y = *y+2;


	if(muva->destroyed == b_false)
		chhar_spawn(metak_muva);

	if(muva->destroyed == b_true)
	{
		if(metak_muva->destroyed == b_false){
			//chhar_spawn(metak_muva);
			if (*y >= 450){
					destroy(metak_muva,metak_muva->x,metak_muva->y);
				}
		}

	}

if(metak_muva->destroyed == b_false){
		if( metak_muva->x >  brod->x - 10 && metak_muva->x <brod->x + 10 && metak_muva->y == brod->y){

			destroy(brod,brod->x,brod->y);
		}
	}


}


void battle_shoot(characters * brod , characters * metak){
	int x = brod -> x;

	if(y == 450){
		metak->destroyed = b_false;
		metak->x = x;
	}

	metak->y = y;
	y = y - 5;

	if(y == -5){
		puca = b_false;
		y = 450;
	}


		chhar_spawn(metak);

		if(metak->destroyed == b_false){
			for(i = 0 ; i < broj_muva ; i++){
				if(muve[i].destroyed == b_false ){
				if( metak->x >  muve[i].x - 10 && metak->x < muve[i].x + 10 && metak->y == muve[i].y){
					destroy(&muve[i],x,metak->y);

						destroy(metak,x,metak->y);
				}
				}
			}
		}

		if(metak->destroyed == b_false){
			for(i = 0 ; i < broj_muva_2 ; i++){
				if(muve_2[i].destroyed == b_false){
				if( metak->x >  muve_2[i].x - 10 && metak->x < muve_2[i].x + 10 && metak->y == muve_2[i].y){
					destroy(&muve_2[i],x,metak->y);

						destroy(metak,x,metak->y);

				}
				}
			}
		}

		if(metak->destroyed == b_false){
			for(i = 0 ; i < broj_muva_3 ; i++){
				if(muve_3[i].destroyed == b_false){
					if( metak->x >  muve_3[i].x - 10 && metak->x < muve_3[i].x + 10 && metak->y == muve_3[i].y){
						destroy(&muve_3[i],x,metak->y);
							destroy(metak,x,metak->y);

					}
			}
		}

		}

		if(metak->destroyed == b_false){
					for(i = 0 ; i < 3 ; i++){
						if(muve_4[i].destroyed == b_false){
							if( metak->x >  muve_4[i].x - 10 && metak->x < muve_4[i].x + 10 && metak->y == muve_4[i].y){
								destroy(&muve_4[i],x,metak->y);
									destroy(metak,x,metak->y);

							}
					}
				}

				}

		if(metak->destroyed == b_false){
							for(i = 0 ; i < 3 ; i++){
								if(muve_5[i].destroyed == b_false){
									if( metak->x >  muve_5[i].x - 10 && metak->x < muve_5[i].x + 10 && metak->y == muve_5[i].y){
										destroy(&muve_5[i],x,metak->y);
											destroy(metak,x,metak->y);

									}
							}
						}

						}


}






void fill_muve(void) {


		muve[0] = muve1_1;
		muve[1] = muve1_2;
		muve[2] = muve1_3;


}

void fill_muve2(void){

	muve_2[0] = muve2_1;
	muve_2[1] = muve2_2;
    muve_2[2] = muve2_3;
    muve_2[3] = muve2_4;
    muve_2[4] = muve2_5;
   // muve_2[5] = muve2_6;
    //muve_2[6] = muve2_7;

}
void fill_muve3(void){
	muve_3[0] = muve3_1;
	muve_3[1] = muve3_2;
	muve_3[2] = muve3_3;
	muve_3[3] = muve3_4;
	muve_3[4] = muve3_5;
	muve_3[5] = muve3_6;
	muve_3[6] = muve3_7;
	//muve_3[7] = muve3_8;
	//muve_3[8] = muve3_9;
}

void fill_muve4(void) {

	muve_4[0] = muve1_4;
	muve_4[1] = muve2_6;
	muve_4[2] = muve3_8;

}
void fill_muve5(void) {

	muve_5[0] = muve1_5;
	muve_5[1] = muve2_7;
	muve_5[2] = muve3_9;

}


/*void set_cursor(Xuint32 new_value){
	cursor_position = new_value;
}

void clear_text_screen(Xuint32 BaseAddress){
	int i;
	for (i = 0; i < 4800; i++){
		VGA_PERIPH_MEM_mWriteMemory(BaseAddress + TEXT_MEM_OFF + i*4, 0x20);
	}
}

void print_string(Xuint32 BaseAddress, unsigned char string_s[], int lenght){
	int i;
	for (i = 0; i < lenght; i++){
		VGA_PERIPH_MEM_mWriteMemory(BaseAddress + TEXT_MEM_OFF + cursor_position + i*4, (string_s[i]-0x40));
	}
}

void clear_graphics_screen(Xuint32 BaseAddress){
	int i;
	for (i = 0; i < 9600; i++){
	    VGA_PERIPH_MEM_mWriteMemory(BaseAddress + GRAPHICS_MEM_OFF + i*4, 0x0);
	}
}

*/

void battle_city( void )
{



	//	XStatus VGA_PERIPH_MEM_SelfTest(void * baseaddr_p);
		unsigned char string_s[] = "***GAME OVER***\n";






	//VGA_PERIPH_MEM_mWriteMemory(XPAR_VGA_PERIPH_MEM_0_S_AXI_MEM0_BASEADDR + 0x04, 0x3);// display_mode  1

	unsigned int buttons, tmpBtn = 0, tmpUp = 0;
	int i,change = 0;
	map_reset( map1 );
	fill_muve();
	fill_muve2();
	fill_muve3();
	fill_muve4();
	fill_muve5();

	/*chhar_spawn(&muve3_9);
	chhar_spawn(&muve3_8);
	chhar_spawn(&muve2_6);
	chhar_spawn(&muve2_7);
	chhar_spawn(&muve1_4);
	chhar_spawn(&muve1_5);*/

	chhar_spawn(&mario);




	int temp1,temp2,temp3,temp4,temp5;

		while( broj_zivota!=0 ) {


			for(i = 0 ; i < 30000; i++){}

			muva_leti(muve,broj_muva,1);
			muva_leti(muve_2,broj_muva_2,2);
			muva_leti(muve_3,broj_muva_3,3);
			//muva_leti2R(muve_4,muve,3,3);
			muva_leti(muve_4,3,3);
			muva_leti(muve_5,3,3);



    	    buttons = XIo_In32( XPAR_IO_PERIPH_BASEADDR );

			if( BTN_LEFT( buttons ) ) {
				mario_move( map1, &mario, DIR_LEFT );
				tmpBtn = 1;
				tmpUp = 0;
			} else if( BTN_RIGHT( buttons ) ) {
				mario_move( map1, &mario, DIR_RIGHT );
				tmpBtn = 0;
				tmpUp = 0;
			} else if( BTN_UP( buttons ) ) {
				puca = b_true;

			} else if( BTN_DOWN( buttons ) ) {

				tmpUp = 0;
			}

			if(puca == b_true){

				battle_shoot(&mario,&metak);

			}

			int r1 = rand() % BROJ_MUVA;
			if (muve[r1].destroyed == b_false){
					temp1 = r1;
			}

			int r2 = rand() % BROJ_MUVA2;
			if (muve_2[r2].destroyed == b_false){
					temp2 = r2;
			}

			int r3 = rand() % BROJ_MUVA3;
			if (muve_3[r3].destroyed == b_false){
					temp3 = r3;
			}
			else {
				//for(i = 0 ; i < broj_muva_3 ; i++)
					//if(muve)
			}
			int r4 = rand() % 3;
				if (muve_4[r4].destroyed == b_false){
						temp4 = r4;
				}
			int r5 = rand() % 3;
			if (muve_5[r5].destroyed == b_false){
						temp5 = r5;
				}

			muva_shoot(&muve[temp1],&metak_muva_1,&mario,&y_muva_1);
			muva_shoot(&muve_2[temp2],&metak_muva_2,&mario,&y_muva_2);
			muva_shoot(&muve_3[temp3],&metak_muva_3,&mario,&y_muva_3);
			muva_shoot(&muve_4[temp4],&metak_muva_4,&mario,&y_muva_4);
			muva_shoot(&muve_5[temp5],&metak_muva_3,&mario,&y_muva_5);


			if(brojac_polozaja > 100){
				promeni_polozaj(muve, broj_muva);
				promeni_polozaj(muve_2, broj_muva_2);
				promeni_polozaj(muve_3, broj_muva_3);
				promeni_polozaj_y(muve_4, 3);
				promeni_polozaj(muve_5, 3);
			}

			if(brojac_polozaja > 101) {
				brojac_polozaja = 0;
			}
			brojac_polozaja+=10;


			chhar_spawn(&zivot_1);
			chhar_spawn(&zivot_2);


		switch(broj_zivota)
		{

			case 2:
			{
				zivot_2.type =IMG_16x16_crno;

				break;
			}
			case 1:
			{
				zivot_1.type =IMG_16x16_crno;

				break;
			}

		}



        map_update( map1 );

    }
		if(broj_zivota==0){

			// VGA_PERIPH_MEM_mWriteMemory(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 0x00, 0x0);// direct mode   0
				  //  VGA_PERIPH_MEM_mWriteMemory(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 0x04, 0x3);// display_mode  1
				   //VGA_PERIPH_MEM_mWriteMemory(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 0x08, 0x1);// show frame      2
				  // VGA_PERIPH_MEM_mWriteMemory(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 0x0C, 0x1);// font size       3


		 	//clear_text_screen(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR);
		    //clear_graphics_screen(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR);
		   // set_cursor(350);
		    //print_string(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR, string_s, 6);
		}
		//if(broj_zivota==0)
		//print_string(XPAR_BATTLE_CITY_PERIPH_0_BASEADDR + 0x04,"IZGUBILI STE,NEMATE POJMA",25);
}


